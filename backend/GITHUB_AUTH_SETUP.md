# GitHub OAuth Authentication Setup Guide

This guide explains how the GitHub OAuth authentication system works in YudaiV3 and how to set it up.

## Overview

The authentication system uses GitHub OAuth 2.0 to authenticate users and provide access to GitHub API functionality through the `ghapi` library. Here's how it works:

### Architecture

1. **Frontend initiates OAuth flow** → User clicks "Login with GitHub"
2. **Backend generates OAuth URL** → Creates secure state parameter and redirects to GitHub
3. **GitHub handles authentication** → User authorizes the application
4. **GitHub redirects back** → With authorization code and state parameter
5. **Backend exchanges code for token** → Gets access token from GitHub
6. **Backend creates/updates user** → Stores user info and token in database
7. **Frontend receives token** → Can now make authenticated API calls

## Setup Instructions

### 1. Create GitHub OAuth App

1. Go to [GitHub Developer Settings](https://github.com/settings/developers)
2. Click "New OAuth App"
3. Fill in the details:
   - **Application name**: `YudaiV3` (or your preferred name)
   - **Homepage URL**: `http://localhost:3000` (for development)
   - **Authorization callback URL**: `http://localhost:3000/auth/callback`
4. Click "Register application"
5. Note down the **Client ID** and **Client Secret**

### 2. Environment Variables

Add these environment variables to your `.env` file or system environment:

```bash
# GitHub OAuth Configuration
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret
GITHUB_REDIRECT_URI=http://localhost:3000/auth/callback

# Database Configuration (if not already set)
DATABASE_URL=postgresql://yudai_user:yudai_password@db:5432/yudai_db
```

### 3. Database Setup

The authentication system requires these database tables (already defined in `models.py`):

- `users` - Stores GitHub user information
- `auth_tokens` - Stores GitHub access tokens

Run the database initialization:

```bash
cd backend
python -c "from db.database import init_db; init_db()"
```

## API Endpoints

### Authentication Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/auth/login` | GET | Initiate GitHub OAuth login |
| `/auth/callback` | GET | Handle OAuth callback |
| `/auth/profile` | GET | Get current user profile |
| `/auth/logout` | POST | Logout user (invalidate token) |
| `/auth/status` | GET | Check authentication status |
| `/auth/config` | GET | Get OAuth configuration status |

### GitHub API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/github/repositories` | GET | Get user's GitHub repositories |
| `/github/repositories/{owner}/{repo}` | GET | Get repository details |
| `/github/repositories/{owner}/{repo}/issues` | GET | Get repository issues |
| `/github/repositories/{owner}/{repo}/issues` | POST | Create new issue |
| `/github/repositories/{owner}/{repo}/pulls` | GET | Get pull requests | 
#TODO implement new pull request using patch generated by swe-agent
| `/github/repositories/{owner}/{repo}/commits` | GET | Get commits |
| `/github/search/repositories` | GET | Search repositories |
#TODO let user create a repository specific agent Coder which will be implemeneted in backend/

## How It Works

### 1. OAuth Flow

```python
# 1. Generate OAuth URL with state parameter
state = generate_oauth_state()
oauth_states[state] = True
auth_url = get_github_oauth_url(state)

# 2. User is redirected to GitHub
# 3. GitHub redirects back with code and state

# 4. Exchange code for access token
token_data = await exchange_code_for_token(code, state)
access_token = token_data["access_token"]

# 5. Get user information
github_user = await get_github_user_info(access_token)

# 6. Create or update user in database
user = await create_or_update_user(db, github_user, access_token)
```

### 2. Token Management

- **Access tokens** are stored in the `auth_tokens` table
- Tokens expire after 8 hours (GitHub's default)
- Users can have multiple active tokens
- Tokens are invalidated on logout

### 3. Authentication Middleware

```python
# Get current user from Bearer token
async def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    db: Session = Depends(get_db)
) -> User:
    token = credentials.credentials
    
    # Find user by token
    auth_token = db.query(AuthToken).filter(
        AuthToken.access_token == token,
        AuthToken.is_active == True,
        AuthToken.expires_at > datetime.utcnow()
    ).first()
    
    if not auth_token:
        raise HTTPException(status_code=401, detail="Invalid or expired token")
    
    return auth_token.user
```

### 4. GitHub API Integration

```python
# Get GitHub API instance for authenticated user
def get_github_api(user_id: int, db: Session) -> GhApi:
    auth_token = db.query(AuthToken).filter(
        AuthToken.user_id == user_id,
        AuthToken.is_active == True,
        AuthToken.expires_at > datetime.utcnow()
    ).first()
    
    if not auth_token:
        raise HTTPException(status_code=401, detail="No valid GitHub token found")
    
    return GhApi(token=auth_token.access_token)
```

## Frontend Integration

### 1. Login Flow

```javascript
// 1. Redirect to backend login endpoint
window.location.href = 'http://localhost:8000/auth/login';

// 2. Handle callback (in your frontend app)
// The callback will return user info and access token
const response = await fetch('/auth/callback?code=...&state=...');
const authData = await response.json();

// 3. Store token for future requests
localStorage.setItem('github_token', authData.access_token);
```

### 2. Authenticated Requests

```javascript
// Include Bearer token in requests
const token = localStorage.getItem('github_token');
const response = await fetch('/github/repositories', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

### 3. Check Authentication Status

```javascript
const response = await fetch('/auth/status', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
const status = await response.json();

if (status.authenticated) {
  console.log('User:', status.user);
} else {
  // Redirect to login
  window.location.href = '/auth/login';
}
```

## Security Considerations

### 1. State Parameter
- Random state parameter prevents CSRF attacks
- State is validated on callback
- Used state is immediately removed

### 2. Token Security
- Access tokens are stored securely in database
- Tokens expire automatically
- Tokens are invalidated on logout

### 3. Scope Management
- Only requests necessary scopes: `repo user email`
- Users can revoke access from GitHub settings

### 4. Error Handling
- Comprehensive error handling for OAuth failures
- Graceful fallback for API errors
- Clear error messages for debugging

## Troubleshooting

### Common Issues

1. **"GitHub Client ID not configured"**
   - Check `GITHUB_CLIENT_ID` environment variable
   - Ensure it's set correctly

2. **"Invalid state parameter"**
   - State parameter expired or invalid
   - Try logging in again

3. **"Failed to exchange code for token"**
   - Check `GITHUB_CLIENT_SECRET`
   - Verify callback URL matches GitHub app settings

4. **"No valid GitHub token found"**
   - Token expired or invalid
   - User needs to re-authenticate

### Debug Endpoints

- `/auth/config` - Check OAuth configuration
- `/auth/status` - Check authentication status
- `/health` - Check API health

## Production Considerations

### 1. Environment Variables
- Use secure environment variable management
- Never commit secrets to version control
- Use different OAuth apps for dev/staging/prod

### 2. Database
- Use production-grade database (PostgreSQL)
- Implement proper backup strategy
- Consider token encryption for additional security

### 3. HTTPS
- Always use HTTPS in production
- Update callback URLs accordingly
- Configure secure headers

### 4. Rate Limiting
- Implement rate limiting for OAuth endpoints
- Monitor GitHub API rate limits
- Handle rate limit errors gracefully

## Testing

### Manual Testing

1. Start the backend server
2. Visit `http://localhost:8000/auth/login`
3. Complete GitHub OAuth flow
4. Test authenticated endpoints

### API Testing

```bash
# Test authentication status
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/auth/status

# Test GitHub repositories
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/github/repositories
```

This authentication system provides a secure, scalable way to integrate GitHub functionality into your application while maintaining user privacy and security. 